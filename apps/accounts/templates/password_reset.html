{% extends 'base_landing.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "Recuperar contraseña - PymeMad" %}{% endblock %}
{% block description %}{% trans "Recupera tu contraseña de acceso" %}{% endblock %}
{% block extra_css %}
<style>
    /* Reset para página de recuperación */
    body {
        overflow-x: hidden;
    }
    /* Ocultar header y footer del base template */
    .page-wrapper > header,
    .page-wrapper > footer,
    .btn-scroll-top {
        display: none !important;
    }
    /* Contenedor principal */
    .reset-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        position: relative;
    }
    /* Botón de regreso */
    .back-to-login {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 10;
    }
    @media (min-width: 576px) {
        .back-to-login {
            top: 2rem;
            right: 2rem;
        }
    }
    /* Contenedor del formulario */
    .reset-form-wrapper {
        width: 100%;
        max-width: 526px;
        background: white;
        padding: 2.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .brand-logo {
        max-width: 180px;
        height: auto;
        margin-bottom: 2rem;
    }
    /* Animación para el botón */
    .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.65;
    }
    .btn-loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        margin: auto;
        border: 2px solid transparent;
        border-radius: 50%;
        border-top-color: #ffffff;
        animation: spin 0.6s linear infinite;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
</style>
{% endblock %}
{% block header %}{% endblock %}
{% block content %}
<div class="reset-page">
    <!-- Botón de regreso -->
    <a class="back-to-login btn btn-icon bg-light border rounded-circle"
       href="{% url 'accounts:login' %}"
       data-bs-toggle="tooltip"
       data-bs-placement="left"
       title="{% trans 'Volver al inicio de sesión' %}">
        <i class="ai-arrow-left text-dark"></i>
    </a>
    <!-- Contenedor del formulario -->
    <div class="reset-form-wrapper">
        <!-- Logo -->
        <div class="text-center">
            <img src="{% static 'assets/img/logo_pymemad.webp' %}" alt="PymeMad" class="brand-logo">
        </div>
        <!-- Título -->
        <h1 class="h3 text-center mb-2">{% trans "¿Olvidaste tu contraseña?" %}</h1>
        <p class="text-muted text-center pb-3 mb-3">
            {% trans "No te preocupes, te enviaremos las instrucciones de recuperación." %}
        </p>
        <!-- Formulario -->
        <form method="post" id="reset-form" action="{% url 'accounts:password_reset' %}" class="needs-validation" novalidate>
            {% csrf_token %}
            {% if form.non_field_errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ form.non_field_errors.0 }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
            <!-- Email -->
            <div class="pb-3 mb-3">
                <label for="{{ form.email.id_for_label }}" class="form-label">
                    {{ form.email.label }}
                </label>
                <div class="position-relative">
                    <i class="ai-mail fs-lg position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.email.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.email.help_text %}
                        <div class="form-text">{{ form.email.help_text }}</div>
                    {% endif %}
                </div>
            </div>
            <!-- Botón submit -->
            <button class="btn btn-lg btn-primary w-100 mb-3" type="submit" id="submit-btn">
                {% trans "Enviar instrucciones" %}
            </button>
            <!-- Link de regreso -->
            <div class="text-center">
                <a href="{% url 'accounts:login' %}" class="text-decoration-none">
                    <i class="ai-arrow-left fs-sm me-1"></i>
                    {% trans "Volver al inicio de sesión" %}
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block footer %}{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reset-form');
    const submitBtn = document.getElementById('submit-btn');
    const originalBtnText = submitBtn.innerHTML;
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        // Validación del formulario
        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            return;
        }
        // Deshabilitar botón y mostrar loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {% trans "Enviando..." %}
        `;
        // Enviar formulario
        const formData = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (response.ok) {
                // Redirigir a la página de confirmación
                window.location.href = "{% url 'accounts:password_reset_done' %}";
            } else {
                return response.text();
            }
        })
        .then(html => {
            if (html) {
                // Recargar la página con los errores del servidor
                document.open();
                document.write(html);
                document.close();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Restaurar el botón en caso de error
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
    });
});
</script>
{% endblock %}
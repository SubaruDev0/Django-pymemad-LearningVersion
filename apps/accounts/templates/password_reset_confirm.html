{% extends 'base_landing.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "Nueva contraseña - PymeMad" %}{% endblock %}
{% block description %}{% trans "Establece tu nueva contraseña" %}{% endblock %}
{% block extra_css %}
<style>
    /* Reset para página */
    body {
        overflow-x: hidden;
    }
    /* Ocultar header y footer del base template */
    .page-wrapper > header,
    .page-wrapper > footer,
    .btn-scroll-top {
        display: none !important;
    }
    /* Contenedor principal */
    .confirm-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }
    /* Contenedor del formulario */
    .confirm-wrapper {
        width: 100%;
        max-width: 526px;
        background: white;
        padding: 2.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .brand-logo {
        max-width: 180px;
        height: auto;
        margin-bottom: 2rem;
    }
    .error-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 2rem;
        background: #ef4444;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .error-icon i {
        color: white;
        font-size: 2.5rem;
    }
    /* Indicador de fortaleza de contraseña */
    .password-strength {
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
    }
    .password-strength-bar {
        height: 100%;
        transition: width 0.3s, background-color 0.3s;
    }
    .strength-weak { background-color: #ef4444; width: 33%; }
    .strength-medium { background-color: #f59e0b; width: 66%; }
    .strength-strong { background-color: #10b981; width: 100%; }
</style>
{% endblock %}
{% block header %}{% endblock %}
{% block content %}
<div class="confirm-page">
    <div class="confirm-wrapper">
        <!-- Logo -->
        <div class="text-center">
            <img src="{% static 'assets/img/logo_pymemad.webp' %}" alt="PymeMad" class="brand-logo">
        </div>
        {% if validlink %}
            <!-- Título -->
            <h1 class="h3 text-center mb-2">{% trans "Establece tu nueva contraseña" %}</h1>
            <p class="text-muted text-center pb-3 mb-3">
                {% trans "Por favor, ingresa una contraseña segura que puedas recordar." %}
            </p>
            <!-- Formulario -->
            <form method="post" id="confirm-form" class="needs-validation" novalidate>
                {% csrf_token %}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        {{ form.non_field_errors.0 }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endif %}
                <!-- Nueva contraseña -->
                <div class="pb-3 mb-3">
                    <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                        {{ form.new_password1.label }}
                    </label>
                    <div class="position-relative">
                        <i class="ai-lock-closed fs-lg position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                        <div class="password-toggle">
                            {{ form.new_password1 }}
                            <label class="password-toggle-btn" aria-label="{% trans 'Mostrar/ocultar contraseña' %}">
                                <input class="password-toggle-check" type="checkbox">
                                <span class="password-toggle-indicator"></span>
                            </label>
                        </div>
                    </div>
                    <div class="password-strength">
                        <div class="password-strength-bar" id="strength-bar"></div>
                    </div>
                    {% if form.new_password1.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.new_password1.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.new_password1.help_text %}
                        <div class="form-text">{{ form.new_password1.help_text }}</div>
                    {% endif %}
                </div>
                <!-- Confirmar contraseña -->
                <div class="mb-4">
                    <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                        {{ form.new_password2.label }}
                    </label>
                    <div class="position-relative">
                        <i class="ai-lock-closed fs-lg position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                        <div class="password-toggle">
                            {{ form.new_password2 }}
                            <label class="password-toggle-btn" aria-label="{% trans 'Mostrar/ocultar contraseña' %}">
                                <input class="password-toggle-check" type="checkbox">
                                <span class="password-toggle-indicator"></span>
                            </label>
                        </div>
                    </div>
                    {% if form.new_password2.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.new_password2.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                <!-- Botón submit -->
                <button class="btn btn-lg btn-primary w-100 mb-3" type="submit" id="submit-btn">
                    {% trans "Cambiar contraseña" %}
                </button>
            </form>
        {% else %}
            <!-- Mensaje de error para enlace inválido -->
            <div class="text-center">
                <div class="error-icon">
                    <i class="ai-x"></i>
                </div>
                <h1 class="h3 mb-3">{% trans "Enlace inválido o expirado" %}</h1>
                <p class="text-muted mb-4">
                    {% trans "El enlace de recuperación de contraseña es inválido o ha expirado. Por favor, solicita uno nuevo." %}
                </p>
                <div class="d-grid gap-2">
                    <a href="{% url 'accounts:password_reset' %}" class="btn btn-primary">
                        {% trans "Solicitar nuevo enlace" %}
                    </a>
                    <a href="{% url 'accounts:login' %}" class="btn btn-outline-secondary">
                        {% trans "Volver al inicio de sesión" %}
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block footer %}{% endblock %}
{% block extra_js %}
{% if validlink %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Medidor de fortaleza de contraseña
    const passwordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
    const strengthBar = document.getElementById('strength-bar');
    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            // Criterios de fortaleza
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;
            // Actualizar barra
            strengthBar.className = 'password-strength-bar';
            if (password.length > 0) {
                if (strength <= 1) {
                    strengthBar.classList.add('strength-weak');
                } else if (strength <= 2) {
                    strengthBar.classList.add('strength-medium');
                } else {
                    strengthBar.classList.add('strength-strong');
                }
            }
        });
    }
    // Validación del formulario y envío con AJAX
    const form = document.getElementById('confirm-form');
    const submitBtn = document.getElementById('submit-btn');
    const password1Input = document.getElementById('{{ form.new_password1.id_for_label }}');
    const password2Input = document.getElementById('{{ form.new_password2.id_for_label }}');
    const originalBtnText = submitBtn.innerHTML;

    // Función para validar que las contraseñas coinciden
    function validatePasswordMatch() {
        if (password1Input.value && password2Input.value) {
            if (password1Input.value !== password2Input.value) {
                password2Input.setCustomValidity('{% trans "Las contraseñas no coinciden" %}');
                // Mostrar mensaje de error
                let errorDiv = password2Input.parentElement.parentElement.querySelector('.password-mismatch-error');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback d-block password-mismatch-error';
                    errorDiv.textContent = '{% trans "Las contraseñas no coinciden" %}';
                    password2Input.parentElement.parentElement.appendChild(errorDiv);
                }
            } else {
                password2Input.setCustomValidity('');
                // Remover mensaje de error si existe
                const errorDiv = password2Input.parentElement.parentElement.querySelector('.password-mismatch-error');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }
        }
    }

    // Validar mientras el usuario escribe
    password2Input.addEventListener('input', validatePasswordMatch);
    password1Input.addEventListener('input', function() {
        if (password2Input.value) {
            validatePasswordMatch();
        }
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Validar que las contraseñas coinciden
        validatePasswordMatch();

        // Validación HTML5
        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        // Validación adicional de longitud
        if (password1Input.value.length < 8) {
            let errorDiv = password1Input.parentElement.parentElement.querySelector('.password-length-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback d-block password-length-error';
                errorDiv.textContent = '{% trans "La contraseña debe tener al menos 8 caracteres" %}';
                password1Input.parentElement.parentElement.appendChild(errorDiv);
            }
            return;
        }

        // Mostrar loading en el botón
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {% trans "Cambiando contraseña..." %}
        `;

        // Enviar formulario con AJAX
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (response.ok || response.redirected) {
                // Si es exitoso, redirigir a la página de éxito
                window.location.href = "{% url 'accounts:password_reset_complete' %}";
            } else {
                return response.text();
            }
        })
        .then(html => {
            if (html) {
                // Parsear la respuesta HTML para extraer errores
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Buscar errores del formulario
                const errorElements = doc.querySelectorAll('.invalid-feedback, .alert-danger');
                if (errorElements.length > 0) {
                    // Mostrar errores sin recargar la página
                    errorElements.forEach(error => {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger alert-dismissible fade show mb-3';
                        alertDiv.innerHTML = `
                            ${error.textContent}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        form.insertBefore(alertDiv, form.firstChild);
                    });
                }

                // Restaurar el botón
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Mostrar error genérico
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mb-3';
            alertDiv.innerHTML = `
                {% trans "Ocurrió un error al procesar tu solicitud. Por favor, intenta nuevamente." %}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            form.insertBefore(alertDiv, form.firstChild);

            // Restaurar el botón
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
    });

    // Fix: El tema tiene los iconos invertidos - checked muestra ojo tachado (contraseña oculta)
    const passwordToggles = document.querySelectorAll('.password-toggle');
    passwordToggles.forEach(function(toggle) {
        const checkbox = toggle.querySelector('.password-toggle-check');
        const passwordInput = toggle.querySelector('input.form-control');

        if (checkbox && passwordInput) {
            // Estado inicial: password oculto = checkbox checked (para mostrar icono correcto)
            passwordInput.type = 'password';
            checkbox.checked = true;
            checkbox.setAttribute('autocomplete', 'off');

            // Agregar el comportamiento invertido
            checkbox.addEventListener('change', function() {
                // Invertir la lógica: checked = password oculto, unchecked = password visible
                passwordInput.type = this.checked ? 'password' : 'text';
            });
        }
    });
});
</script>
{% endif %}
{% endblock %}